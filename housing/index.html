<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guild Housing Maps</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="grid-overlay.css">
</head>
<body>
    <div class="map-container">
        <div class="map-background" id="mapBackground">
            <!-- House plots will be dynamically positioned here -->
        </div>
    </div>

    <div class="legend">
        <h2>Subdivision 1</h2>
        <h3>Legend</h3>
        <div class="legend-item">
            <div class="legend-color available"></div>
            <span>Available</span>
        </div>
        <div class="legend-item">
            <div class="legend-color occupied"></div>
            <span>Reserved</span>
        </div>
        <div class="legend-item">
            <div class="legend-color purchased"></div>
            <span>Purchased</span>
        </div>
        <div class="legend-item">
            <div class="legend-color interested"></div>
            <span>Someone's interested in it</span>
        </div>
        <div style="margin-top: 10px; font-size: 10px; color: #ccc;">
            Press <strong>G</strong> to toggle grid
        </div>
    </div>

    <script>
        // Housing data from CSV
        const housingData = {
            3: "Tetani",
            10: "Cóleth",
            21: "Cwelanas",
            26: "Rico",
        };

        const interestedData = {
            4: "Saevash",
        };

        const purchasedData = {
            0: "Malfreyia / Fablewynd",
            1: "Elëos",
            2: "Insinc",
            5: "Céndal",
            6: "Arcanaeus",
            7: "Artemis",
            8: "Loxille",
            11: "Myffanwy",
            12: "Nathellis",
            13: "Lazryn",
            14: "Alymere",
            15: "Smeson",
            16: "Evitel",
            17: "DiscordianKitty / Zzof",
            18: "Ljudevit",
            19: "Wimblenop",
            20: "Inine / Neideen",
            22: "Kaldirk",
            23: "Epiphania",
            24: "Entheras / Nultopia",
            25: "Ormyn",
            27: "Taleniel",
            28: "Dot",
            29: "Mystica",
            30: "Evarock",
            31: "Lany",
            32: "Atlen",
            33: "Knefes",
            34: "Jaretia",
            35: "Vitiae",
            36: "Pandacho",
            37: "Kymchi",
            38: "Béafyre",
            39: "Korrelim",
            40: "Burrich / Shenwick",
            41: "Jangrol",
            42: "Tissais",
            43: "Patek",
            44: "Thalnis",
            45: "Sunniest",
            46: "Scolar",
            47: "Kaput",
            48: "Hedning",
            49: "Cloudspear",
            50: "Ikuska",
            51: "Tiareth",
            52: "Dalmasca",
            53: "Darsuss",
            54: "Lárrý"
        };

        // House plot positions loaded from external JSON file
        let plotPositions = [];
        let mapImageData = {};

        async function loadPlotPositions() {
            try {
                const response = await fetch('plot-positions.json');
                const data = await response.json();
                plotPositions = data.plotPositions;
                mapImageData = data.referenceImage;
                console.log('Plot positions loaded successfully:', data);
            } catch (error) {
                console.error('Error loading plot positions:', error);
                // Fallback to empty array if JSON fails to load
                plotPositions = [];
            }
        }

        function createHousePlots() {
            const mapBackground = document.getElementById('mapBackground');
            
            // Clear existing plots
            mapBackground.innerHTML = '';
            
            plotPositions.forEach((position) => {
                const plot = document.createElement('div');
                plot.className = 'house-plot';
                plot.textContent = position.plotNumber;
                
                // Check if plot is occupied
                if (housingData[position.plotNumber]) {
                    plot.classList.add('occupied');
                    
                    // Add tooltip with buyer name
                    const tooltip = document.createElement('div');
                    tooltip.className = 'plot-info';
                    tooltip.textContent = `Reserved ${position.plotNumber}: ${housingData[position.plotNumber]}`;
                    plot.appendChild(tooltip);
                } else if (interestedData[position.plotNumber]) {
                    plot.classList.add('interested');
                    
                    // Add tooltip with buyer name
                    const tooltip = document.createElement('div');
                    tooltip.className = 'plot-info';
                    tooltip.textContent = `Interested in plot ${position.plotNumber}: ${interestedData[position.plotNumber]}`;
                    plot.appendChild(tooltip); 
                } else if (purchasedData[position.plotNumber]) {
                    plot.classList.add('purchased');
                    
                    // Add tooltip with buyer name
                    const tooltip = document.createElement('div');
                    tooltip.className = 'plot-info';
                    tooltip.textContent = `Purchased ${position.plotNumber}: ${purchasedData[position.plotNumber]}`;
                    plot.appendChild(tooltip); 
                } else {
                    // Add tooltip for available plot
                    const tooltip = document.createElement('div');
                    tooltip.className = 'plot-info';
                    tooltip.textContent = `Plot ${position.plotNumber}: Available`;
                    plot.appendChild(tooltip);
                }
                
                // Position the plot
                plot.style.left = position.x + 'px';
                plot.style.top = position.y + 'px';
                
                mapBackground.appendChild(plot);
            });
        }

        function updatePlotPositions() {
            const mapBackground = document.getElementById('mapBackground');
            const plots = document.querySelectorAll('.house-plot');
            
            if (plots.length === 0) return;
            
            // Get the actual map image dimensions and position (same logic as grid)
            const mapImage = new Image();
            mapImage.onload = function() {
                const mapRect = mapBackground.getBoundingClientRect();
                const containerWidth = mapRect.width;
                const containerHeight = mapRect.height;
                
                // Calculate the actual displayed image dimensions (maintaining aspect ratio)
                const imageAspectRatio = mapImage.width / mapImage.height;
                const containerAspectRatio = containerWidth / containerHeight;
                
                let imageWidth, imageHeight, offsetX, offsetY;
                
                if (imageAspectRatio > containerAspectRatio) {
                    // Image is wider than container
                    imageWidth = containerWidth;
                    imageHeight = containerWidth / imageAspectRatio;
                    offsetX = 0;
                    offsetY = (containerHeight - imageHeight) / 2;
                } else {
                    // Image is taller than container
                    imageHeight = containerHeight;
                    imageWidth = containerHeight * imageAspectRatio;
                    offsetX = (containerWidth - imageWidth) / 2;
                    offsetY = 0;
                }
                
                // Calculate scale factor from original image to displayed image
                const scaleX = imageWidth / mapImage.width;
                const scaleY = imageHeight / mapImage.height;
                
                // Update plot positions using the same logic as grid
                plots.forEach((plot, index) => {
                    const originalPos = plotPositions[index];
                    if (originalPos) {
                        const scaledX = offsetX + (originalPos.x * scaleX);
                        const scaledY = offsetY + (originalPos.y * scaleY);
                        
                        plot.style.left = scaledX + 'px';
                        plot.style.top = scaledY + 'px';
                    }
                });
            };
            
            mapImage.src = 'map.jpg';
        }

        // Initialize the map
        document.addEventListener('DOMContentLoaded', async function() {
            // Load plot positions from JSON file first
            await loadPlotPositions();
            
            // Create house plots after positions are loaded
            createHousePlots();
            
            // Update positions on window resize
            let plotResizeTimeout;
            window.addEventListener('resize', function() {
                // Clear existing timeout to prevent multiple rapid calls
                clearTimeout(plotResizeTimeout);
                // Update immediately for responsiveness
                updatePlotPositions();
            });
            
            // Initial position update
            setTimeout(updatePlotPositions, 100);
            
            // Create initial grid overlay
            //setTimeout(createGridOverlay, 500);
        });
    </script>
    <script src="grid-overlay.js"></script>
</body>
</html>
